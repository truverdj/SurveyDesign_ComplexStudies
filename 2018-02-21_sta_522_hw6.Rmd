---
title: "STA 522 HW6 (Multi-Stage Sampling)"
author: "Daniel Truver"
date: "2/21/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### (1) Lohr, Chapter 6 Problem 4  

We begin with showing $\hat{t}_\psi$ is unbiased. 
$$
E(\hat{t}_\psi) 
= E\left( \frac{t_i}{\psi_i} \right) 
= \sum_{i} \left( \frac{t_i}{\psi_i} \right) \psi_i
= \sum_i t_i = t.
$$

```{r 1.lazyCalculation, include=FALSE}
psi = c(7/16, rep(3/16,3))
t = c(11,20,24,245)
variance = 0
for (i in 1:4){
  variance = variance + (t[i]/psi[i] - 300)^2 * psi[i]
}
```

The variacne of $\hat{t}_\psi$ is given by the following.
$$
\begin{aligned}
Var(\hat{t}_\psi) 
&= E\left[(\hat{t}_\psi - t)^2\right] \\
&= \sum_i \left( \frac{t_i}{\psi_i} - t \right)^2 \psi_i \\
&= (11(16/7) - 300)^2(7/16) + (20(16/3) - 300)^2(3/16)\\
&\quad\quad + (24(16/3) - 300)^2(3/16) + (245(16/3) - 300)^2(3/16) \\
&\approx 2.36 \times 10^5
\end{aligned}
$$

This variance is much worse than the variance of the $\pi$ps estimator used in section 6.1, an estimator which is also unbiased. Therefore, we do not have a reason to use this distribution for $\psi_i$. Intuitively, it does not make sense to put so much weight on the smallest of the supermarkets. 

#### (2) Lohr, Chapter 6 Problem 12

##### (a) Plotting Probability vs Number of Farms

```{r readThatStatepopData, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(survey)
statepop = read.csv("statepop.csv")
M_0 = 255077536
statepop = statepop %>%
  mutate(psi = popn/M_0) %>%
  mutate(that = phys/psi)
ggplot(data = statepop, aes(x = psi, y = numfarm)) +
  geom_point() + 
  geom_smooth(method = "lm") +
  xlab("Number of Farms") +
  ggtitle("Number of Farms in State vs Probability of Selection") +
  theme_bw()
```

There appears to be some positive correlation here, but it is not strong. Considering how much leverage Los Angeles county has, we cannot say in good conscience that this sampling design will be efficient for estimating total number of farms.

Does this make intuitive sense? Yes, the counties were sampled based on population size, but rural areas with plentiful farms tend to have lower population. 

##### (b) Total Number of Farms in US

```{r totalFarmsInUS}
svy.farms = svydesign(ids = ~county, weights = statepop$psi, data = statepop)
total.farms = svytotal(~numfarm, svy.farms)
```

```{r 2b.table, echo=FALSE}
knitr::kable(data.frame(total.farms),
             col.names = c("Total", "Standard Error"),
             row.names = FALSE, digits = 0, 
             caption = "Total Number of Farms in the U.S.")
```

#### (3) Lohr, Chapter 6 Problem 13

Data from example 6.5

